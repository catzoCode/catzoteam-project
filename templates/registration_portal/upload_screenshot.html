{% extends 'registration_portal/base.html' %}

{% block title %}Upload Screenshot ¬∑ Catzonia{% endblock %}

{% block content %}
<!-- NAVBAR -->
<nav class="navbar-apple">
    <div class="navbar-content">
        <a href="{% url 'registration_portal:dashboard' %}" class="navbar-brand">
            <i class="fas fa-cat"></i>
            <span>Catzonia</span>
        </a>
        <div class="navbar-actions">
            <div class="navbar-badge">
                <i class="fas fa-building"></i> {{ user.get_branch_display }}
            </div>
            <div class="navbar-badge">
                <i class="fas fa-user-circle"></i> {{ user.first_name|default:user.username }}
            </div>
            <a href="{% url 'registration_portal:dashboard' %}" class="btn-apple btn-apple-sm btn-secondary">
                <i class="fas fa-arrow-left"></i> Back
            </a>
        </div>
    </div>
</nav>

<!-- MAIN CONTENT -->
<div class="container-apple">
    <div class="card-apple animate-fade-in-up" style="max-width: 600px; margin: 0 auto;">
        <div class="card-header-apple">
            <h2><i class="fas fa-camera"></i> Upload Portal Collar Screenshot</h2>
        </div>
        <div class="card-body-apple">
            
            <!-- Info Box -->
            <div style="padding: var(--space-4); background: #e3f2fd; border-radius: var(--radius-md); margin-bottom: var(--space-6); border-left: 4px solid var(--apple-blue);">
                <div class="font-semibold mb-2" style="color: var(--apple-blue);">
                    <i class="fas fa-info-circle"></i> How to Use OCR
                </div>
                <ol style="margin: 0; padding-left: var(--space-5); font-size: 14px;">
                    <li class="mb-2">Take a clear screenshot of Portal Collar customer form</li>
                    <li class="mb-2">Make sure text is visible and not blurry</li>
                    <li class="mb-2">Upload the screenshot below</li>
                    <li class="mb-2">Review auto-filled data and make corrections if needed</li>
                    <li>Save to create customer</li>
                </ol>
            </div>

            <!-- Upload Form -->
            <form method="post" enctype="multipart/form-data" id="uploadForm">
                {% csrf_token %}
                
                <div class="input-group" style="margin-bottom: var(--space-6);">
                    <label class="input-label">
                        <i class="fas fa-image"></i> Screenshot File *
                    </label>
                    <input type="file" 
                           name="screenshot" 
                           accept="image/*"
                           capture="environment"
                           class="input-apple"
                           required
                           id="screenshotInput"
                           style="padding: var(--space-3);">
                    <p class="text-sm text-secondary" style="margin-top: var(--space-2);">
                        üì∏ Supported: JPG, PNG, WEBP (Max 5MB)
                    </p>
                </div>

                <!-- Preview Area -->
                <div id="previewArea" style="display: none; margin-bottom: var(--space-6);">
                    <label class="input-label">Preview:</label>
                    <div style="border: 2px dashed var(--apple-gray-300); border-radius: var(--radius-md); padding: var(--space-4); text-align: center;">
                        <img id="previewImage" 
                             style="max-width: 100%; max-height: 400px; border-radius: var(--radius-md);" 
                             alt="Preview">
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex gap-3">
                    <a href="{% url 'registration_portal:dashboard' %}" 
                       class="btn-apple btn-secondary" 
                       style="flex: 1;">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                    <button type="submit" 
                            class="btn-apple btn-success btn-apple-lg" 
                            style="flex: 2;"
                            id="uploadButton">
                        <i class="fas fa-magic"></i> Extract Data
                    </button>
                </div>
            </form>

            <!-- Tips -->
            <div style="margin-top: var(--space-6); padding: var(--space-4); background: var(--apple-gray-50); border-radius: var(--radius-md);">
                <div class="font-semibold mb-2">
                    <i class="fas fa-lightbulb"></i> Tips for Best Results
                </div>
                <ul style="margin: 0; padding-left: var(--space-5); font-size: 13px;">
                    <li class="mb-1">‚úì Use good lighting</li>
                    <li class="mb-1">‚úì Keep text straight and not rotated</li>
                    <li class="mb-1">‚úì Avoid shadows or glare</li>
                    <li class="mb-1">‚úì Focus on the customer info section</li>
                    <li>‚úì Higher resolution = better accuracy</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// Preview image before upload
document.getElementById('screenshotInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    
    if (file) {
        // Validate file size
        if (file.size > 5 * 1024 * 1024) {
            alert('‚ö†Ô∏è File too large! Maximum 5MB.');
            this.value = '';
            return;
        }
        
        // Validate file type
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
            alert('‚ö†Ô∏è Only JPG, PNG, WEBP images allowed!');
            this.value = '';
            return;
        }
        
        // Show preview
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('previewImage').src = e.target.result;
            document.getElementById('previewArea').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
});

// Show loading on submit
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    const button = document.getElementById('uploadButton');
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Extracting...';
});
</script>
{% endblock %}