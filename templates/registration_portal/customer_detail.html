{% extends 'registration_portal/base.html' %}

{% block title %}Customer Details ¬∑ Catzonia{% endblock %}

{% block content %}
<!-- NAVBAR -->
<nav class="navbar-apple">
    <div class="navbar-content">
        <a href="{% url 'registration_portal:dashboard' %}" class="navbar-brand">
            <i class="fas fa-cat"></i>
            <span>Catzonia</span>
        </a>
        <div class="navbar-actions">
            <div class="navbar-badge">
                <i class="fas fa-building"></i> {{ user.get_branch_display }}
            </div>
            <div class="navbar-badge">
                <i class="fas fa-user-circle"></i> {{ user.first_name|default:user.username }}
            </div>
            <a href="{% url 'registration_portal:dashboard' %}" class="btn-apple btn-apple-sm btn-secondary">
                <i class="fas fa-arrow-left"></i> Back
            </a>
        </div>
    </div>
</nav>

<!-- MAIN CONTENT -->
<div class="container-apple">
    <!-- Customer Information -->
    <div class="card-apple mb-4 animate-fade-in-up">
        <div class="card-header-apple">
            <h2><i class="fas fa-user-circle"></i> Customer Information</h2>
            <div class="navbar-badge">{{ customer.customer_id }}</div>
        </div>
        <div class="card-body-apple">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-6);">
                <div>
                    <h3 class="text-2xl font-semibold mb-4">{{ customer.name }}</h3>
                    
                    <div class="mb-3">
                        <div class="text-sm text-secondary mb-1">
                            <i class="fas fa-phone"></i> Phone
                        </div>
                        <div class="font-medium">{{ customer.phone }}</div>
                    </div>
                    
                    {% if customer.email %}
                    <div class="mb-3">
                        <div class="text-sm text-secondary mb-1">
                            <i class="fas fa-envelope"></i> Email
                        </div>
                        <div class="font-medium">{{ customer.email }}</div>
                    </div>
                    {% endif %}
                    
                    {% if customer.ic_number %}
                    <div class="mb-3">
                        <div class="text-sm text-secondary mb-1">
                            <i class="fas fa-id-card"></i> IC Number
                        </div>
                        <div class="font-medium">{{ customer.ic_number }}</div>
                    </div>
                    {% endif %}
                </div>
                
                <div>
                    {% if customer.address %}
                    <div class="mb-3">
                        <div class="text-sm text-secondary mb-1">
                            <i class="fas fa-map-marker-alt"></i> Address
                        </div>
                        <div class="font-medium">{{ customer.address }}</div>
                    </div>
                    {% endif %}
                    
                    {% if customer.emergency_contact %}
                    <div class="mb-3">
                        <div class="text-sm text-secondary mb-1">
                            <i class="fas fa-phone-square"></i> Emergency Contact
                        </div>
                        <div class="font-medium">{{ customer.emergency_contact }}</div>
                    </div>
                    {% endif %}
                    
                    <div class="text-sm text-secondary">
                        <i class="fas fa-clock"></i> Registered {{ customer.created_at|timesince }} ago
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card-apple mb-6 animate-fade-in-up">
        <div class="card-header-apple">
            <h2>Quick Actions</h2>
        </div>
        <div class="card-body-apple">
            <div class="tiles-grid">
                <a href="{% url 'registration_portal:register_cat' customer.customer_id %}" 
                   class="tile-apple" 
                   style="text-decoration: none; border: 2px solid var(--apple-green);">
                    <div class="tile-icon">üê±</div>
                    <div class="tile-name" style="color: var(--apple-green);">Register Cat</div>
                    <div class="tile-subtitle">Add new cat</div>
                </a>

                <a href="{% url 'registration_portal:create_service_request' customer.customer_id %}" 
                   class="tile-apple" 
                   style="text-decoration: none; border: 2px solid var(--apple-blue);">
                    <div class="tile-icon">üìã</div>
                    <div class="tile-name" style="color: var(--apple-blue);">Create Booking</div>
                    <div class="tile-subtitle">New service</div>
                </a>

                <a href="{% url 'registration_portal:dashboard' %}" 
                   class="tile-apple" 
                   style="text-decoration: none;">
                    <div class="tile-icon">üè†</div>
                    <div class="tile-name">Dashboard</div>
                    <div class="tile-subtitle">Go home</div>
                </a>
            </div>
        </div>
    </div>

    <!-- Registered Cats -->
    <div class="card-apple mb-6 animate-fade-in-up">
        <div class="card-header-apple">
            <h2><i class="fas fa-cat"></i> Registered Cats</h2>
            <div class="navbar-badge">{{ cats.count }} cat(s)</div>
        </div>
        <div class="card-body-apple">
            {% if cats %}
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: var(--space-4);">
                    {% for cat in cats %}
                    <div class="card-apple" style="margin: 0; {% if cat.vaccination_status == 'up_to_date' %}border: 2px solid var(--apple-green);{% elif cat.vaccination_status == 'overdue' %}border: 2px solid var(--apple-orange);{% elif cat.vaccination_status == 'not_vaccinated' %}border: 2px solid var(--apple-red);{% endif %}">
                        <div class="card-body-apple">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-xl font-semibold">üê± {{ cat.name }}</h3>
                                {% if cat.vaccination_status == 'up_to_date' %}
                                <span class="tile-badge" style="background: var(--apple-green);">‚úì Vaccinated</span>
                                {% elif cat.vaccination_status == 'overdue' %}
                                <span class="tile-badge" style="background: var(--apple-orange);">‚ö† Overdue</span>
                                {% elif cat.vaccination_status == 'not_vaccinated' %}
                                <span class="tile-badge" style="background: var(--apple-red);">‚úó Not Vaccinated</span>
                                {% else %}
                                <span class="tile-badge">? Unknown</span>
                                {% endif %}
                            </div>
                            
                            <div class="text-sm text-secondary mb-3">
                                <i class="fas fa-tag"></i> {{ cat.cat_id }}
                            </div>
                            
                            <div class="text-sm mb-3">
                                <strong>Breed:</strong> {{ cat.breed }}<br>
                                <strong>Age:</strong> {{ cat.age }} years<br>
                                <strong>Gender:</strong> {{ cat.get_gender_display }}
                                {% if cat.color %}<br><strong>Color:</strong> {{ cat.color }}{% endif %}
                                {% if cat.weight %}<br><strong>Weight:</strong> {{ cat.weight }} kg{% endif %}
                            </div>
                            
                            {% if cat.medical_notes %}
                            <div style="padding: var(--space-3); background: #fff3cd; border-radius: var(--radius-md); margin-bottom: var(--space-2);">
                                <div class="text-sm"><strong>Medical:</strong> {{ cat.medical_notes }}</div>
                            </div>
                            {% endif %}
                            
                            {% if cat.special_requirements %}
                            <div style="padding: var(--space-3); background: #e3f2fd; border-radius: var(--radius-md); margin-bottom: var(--space-2);">
                                <div class="text-sm"><strong>Special:</strong> {{ cat.special_requirements }}</div>
                            </div>
                            {% endif %}
                            
                            <div class="text-sm text-secondary">
                                <i class="fas fa-clock"></i> Registered {{ cat.registration_date|timesince }} ago
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <div class="empty-icon"><i class="fas fa-cat"></i></div>
                    <h3 class="text-xl font-semibold mb-2">No cats registered yet</h3>
                    <p class="text-secondary mb-4">Register the first cat for this customer</p>
                    <a href="{% url 'registration_portal:register_cat' customer.customer_id %}" 
                       class="btn-apple btn-success">
                        <i class="fas fa-plus"></i> Register First Cat
                    </a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Owned Combo Packages -->
    {% if owned_combos %}
    <div class="card-apple mb-6 animate-fade-in-up">
        <div class="card-header-apple">
            <h2><i class="fas fa-gift"></i> Combo Packages</h2>
        </div>
        <div class="card-body-apple">
            <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                {% for combo in owned_combos %}
                <div class="cart-item-apple" style="{% if combo.sessions_remaining == 0 %}opacity: 0.5;{% endif %}">
                    <div style="flex: 1;">
                        <div class="font-semibold mb-1">
                            {{ combo.combo_task_type.name }} - {{ combo.cat.name }}
                        </div>
                        <div class="text-sm text-secondary">
                            <span class="tile-badge" style="background: var(--apple-blue);">
                                {{ combo.sessions_remaining }}/{{ combo.total_sessions }} sessions left
                            </span>
                            <span class="tile-badge">
                                {{ combo.points_awarded }} pts awarded
                            </span>
                        </div>
                    </div>
                    <div class="text-sm text-secondary">
                        Purchased {{ combo.purchased_at|date:"M d, Y" }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Recent Packages -->
    {% if recent_packages %}
    <div class="card-apple animate-fade-in-up">
        <div class="card-header-apple">
            <h2><i class="fas fa-history"></i> Recent Bookings</h2>
            <div class="navbar-badge">{{ recent_packages|length }}</div>
        </div>
        <div class="card-body-apple">
            <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                {% for package in recent_packages %}
                <div class="cart-item-apple">
                    <div style="flex: 1;">
                        <div class="font-semibold mb-1">
                            {{ package.package_id }} - {{ package.cat.name }}
                        </div>
                        <div class="text-sm text-secondary">
                            {% if package.is_combo_package %}
                                <span class="tile-badge" style="background: var(--apple-purple);">Combo Session {{ package.combo_session_number }}/{{ package.combo_total_sessions }}</span>
                            {% else %}
                                <span class="tile-badge">{{ package.total_points }} pts</span>
                            {% endif %}
                            
                            {% if package.booking_type == 'type_a' %}
                                <span class="tile-badge" style="background: var(--apple-green);">Paid</span>
                            {% elif package.booking_type == 'type_b' %}
                                <span class="tile-badge" style="background: var(--apple-purple);">Combo</span>
                            {% elif package.booking_type == 'type_c' %}
                                <span class="tile-badge" style="background: var(--apple-orange);">Pending</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="text-sm text-secondary">
                        {{ package.created_at|date:"M d, Y g:i A" }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
@media (max-width: 768px) {
    .card-body-apple > div[style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
    }
}
</style>
{% endblock %}